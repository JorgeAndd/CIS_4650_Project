%{
	#include <stdlib.h>
	#include <stdio.h>
	
	extern int yylineno;
	extern char *yytext;
	
%}

%union{
	int ival;
	float fval;
	char cval;
	char *sval;
}

%define parse.error verbose

%token PLUS MINUS
%token EQUAL DIFF GE LE
%token AND OR NOT
%token TYPEDEF ASSIGN SIZEOF
%token TKINT TKFLOAT TKCHAR
%token INC DEC
%token DOT QUOTE SEMICOLON COMMA 
%token OBRACES CBRACES OPAR CPAR OBRACKET CBRACKET
%token IF ELSE FOR WHILE RETURN VOID STRUCT

%token <ival> INT
%token <fval> FLOAT
%token <cval> CHAR
%token <sval> NAME

%nonassoc THEN
%nonassoc ELSE

%right ASSIGN
%left OR
%left AND
%left EQUAL DIFF
%left '<' '>' GE LE
%left '+' '-'
%left '*' '/' '%' 
%right SIZEOF NOT UNMINUS UNPLUS
%left INC DEC

%%
program	: type_decl_list var_decl_list function_def_list
		| var_decl_list function_def_list
		| function_def_list
		|
;

type_decl_list	: type_decl SEMICOLON
				| type_decl_list type_decl SEMICOLON
;

/*Rule for the basics type: int, float and char	*/
type_name	: TKINT 
			| TKFLOAT
			| TKCHAR		
			;

type_decl	: TYPEDEF type_name NAME
			| TYPEDEF struct_decl NAME
			;
			
struct_decl	: STRUCT OBRACES var_decl_list CBRACES
				
var_decl	: type_name id_list
			| NAME id_list
			;

id_list	: id_name
 		| id_name COMMA id_list
		;
		
id_name : NAME
		| NAME OBRACKET INT CBRACKET

function_def_list	: function_def
					| function_def_list function_def
;
					
function_def	: type_name NAME OPAR param_list CPAR OBRACES func_body CBRACES
				| VOID NAME OPAR param_list CPAR OBRACES func_body CBRACES
;
				
param_list	: type_name id_name param_decl
			| NAME id_name param_decl
			| 
;

param_decl	: COMMA type_name id_name param_decl
			| COMMA NAME id_name param_decl
			|
;
			
func_body	: var_decl_list stmt_list
			| stmt_list
			|
;

var_decl_list	: var_decl SEMICOLON
				| var_decl_list var_decl SEMICOLON
;
					
stmt_list	: stmt
			| stmt_list stmt
;
			

stmt	: expr_stmt 
		| compound_stmt
		| select_stmt
		| iter_stmt
		| return_stmt
;
		
expr_stmt	: expr SEMICOLON
;

compound_stmt	: OBRACES stmt_list CBRACES
				| OBRACES CBRACES
;

select_stmt : IF OPAR expr CPAR stmt			%prec THEN
			| IF OPAR expr CPAR stmt ELSE stmt
;

iter_stmt	: WHILE OPAR expr CPAR stmt 
			| FOR OPAR expr SEMICOLON expr SEMICOLON expr CPAR stmt
			| FOR OPAR SEMICOLON expr SEMICOLON expr CPAR stmt
     	   	| FOR OPAR expr SEMICOLON SEMICOLON expr CPAR stmt
     	   	| FOR OPAR expr SEMICOLON expr SEMICOLON CPAR stmt
     	   	| FOR OPAR SEMICOLON SEMICOLON expr CPAR stmt
     	   	| FOR OPAR expr SEMICOLON SEMICOLON CPAR stmt
     	   	| FOR OPAR SEMICOLON expr SEMICOLON CPAR stmt
     	   	| FOR OPAR SEMICOLON SEMICOLON CPAR stmt 
;

return_stmt	: RETURN expr SEMICOLON
			| RETURN SEMICOLON
;
			
function_call	: constant OPAR call_param_list CPAR
				| NAME OPAR call_param_list CPAR
;

call_param_list	: constant call_param
				| NAME call_param
				|
;
	
call_param	: COMMA NAME call_param
			| COMMA constant call_param
			|
;
				
expr	: expr '+' expr
		| expr '-' expr
		| expr '*' expr
		| expr '/' expr
		| expr '%' expr
		| expr '>' expr
		| expr '<' expr
		| expr GE expr
		| expr LE expr
		| expr DIFF expr
		| expr EQUAL expr
		| expr OR expr
		| expr AND expr
		| NOT expr 
		| MINUS expr %prec UNMINUS
		| PLUS expr %prec UNPLUS
		| OPAR expr CPAR
		| function_call
		| var ASSIGN expr
		| var
		| var INC
		| var DEC
		| INC var
		| DEC var
		| SIZEOF OPAR expr CPAR
		| SIZEOF OPAR type_name CPAR
		| constant
;
		
var	: NAME
	| NAME OBRACKET expr CBRACKET
	| NAME DOT var
;
	
constant	: const_int
			| const_float
			| const_char
;
			
const_int	: INT
;

const_float	: FLOAT
;

const_char	: CHAR
;
	
			
%%

extern FILE *yyin;

int yyerror (char *s) 
{
	fprintf(stderr, "%d: %s at %s\n",yylineno, s, yytext);
}

int yywrap()
{
        return 1;
} 

main()
{
	yyparse();
}

